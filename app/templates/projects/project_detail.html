{% extends 'layout.html' %}

{% block styles %}
<style>
    .kanban-container {
        overflow-x: auto;
        min-height: 400px;
    }
    
    .kanban-board {
        display: flex;
        gap: 15px;
        min-width: 900px;
    }
    
    .kanban-column {
        flex: 1;
        min-width: 280px;
        background-color: #f8f9fa;
        border-radius: 5px;
        padding: 10px;
    }
    
    .kanban-title {
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 3px;
        font-weight: bold;
        text-align: center;
    }
    
    .todo-column .kanban-title {
        background-color: #e9ecef;
    }
    
    .progress-column .kanban-title {
        background-color: #fff3cd;
    }
    
    .done-column .kanban-title {
        background-color: #d1e7dd;
    }
    
    .kanban-task {
        background: white;
        border-radius: 3px;
        padding: 10px;
        margin-bottom: 10px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        cursor: pointer;
    }
    
    .kanban-task:hover {
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
    
    .task-title {
        font-weight: 500;
        margin-bottom: 5px;
    }
    
    .task-info {
        display: flex;
        justify-content: space-between;
        font-size: 0.8rem;
        margin-top: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>{{ project.name }}</h1>
    <div>
        <a href="{{ url_for('projects.add_credit', project_id=project.id) }}" class="btn btn-success">
            <i class="fas fa-plus me-1"></i>Ajouter du crédit
        </a>
        <a href="{{ url_for('projects.edit_project', project_id=project.id) }}" class="btn btn-outline-primary">
            <i class="fas fa-edit me-1"></i>Modifier
        </a>
        <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteProjectModal">
            <i class="fas fa-trash me-1"></i>Supprimer
        </button>
    </div>
</div>

<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Informations</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Client :</strong> <a href="{{ url_for('clients.client_details', client_id=project.client.id) }}">{{ project.client.name }}</a></p>
                        <p><strong>Date de création :</strong> {{ project.created_at.strftime('%d/%m/%Y') }}</p>
                    </div>
                    <div class="col-md-6">
                        <p>
                            <strong>Crédit restant :</strong> 
                            <span class="{% if project.credit_percent < 20 %}text-danger{% elif project.credit_percent < 50 %}text-warning{% else %}text-success{% endif %}">
                                {{ project.remaining_credit }}h / {{ project.initial_credit }}h
                            </span>
                        </p>
                        <div class="progress credit-progress">
                            <div class="progress-bar {% if project.credit_percent < 20 %}bg-danger{% elif project.credit_percent < 50 %}bg-warning{% else %}bg-success{% endif %}" 
                                 role="progressbar" 
                                 style="width: {{ project.credit_percent }}%" 
                                 aria-valuenow="{{ project.remaining_credit }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="{{ project.initial_credit }}">
                                </div>
                            </div>
                        </div>
                        {% if project.description %}
                            <div class="mt-3">
                                <strong>Description :</strong>
                                <p>{{ project.description }}</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Tableau Kanban des tâches -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-tasks me-2"></i>Tâches</h5>
                        <a href="{{ url_for('tasks.new_task', project_id=project.id) }}" class="btn btn-sm btn-light">
                            <i class="fas fa-plus me-1"></i>Nouvelle tâche
                        </a>
                    </div>
                    <div class="card-body">
                        <div class="kanban-container">
                            <div class="kanban-board">
                                <!-- Colonne "À faire" -->
                                <div class="kanban-column todo-column" data-status="à faire">
                                    <div class="kanban-title">À faire <span class="badge bg-secondary">{{ tasks_todo|length }}</span></div>
                                    <div class="kanban-items">
                                        {% for task in tasks_todo %}
                                            <div class="kanban-task" data-task-id="{{ task.id }}">
                                                <div class="task-title">{{ task.title }}</div>
                                                <div class="text-{{ task.priority }}">
                                                    <i class="fas fa-flag me-1"></i>{{ task.priority }}
                                                </div>
                                                <div class="task-info">
                                                    <span>
                                                        {% if task.estimated_time %}
                                                            <i class="fas fa-clock me-1"></i>{{ task.estimated_time }}h
                                                        {% endif %}
                                                    </span>
                                                    <span>
                                                        {% if task.user_id %}
                                                            <i class="fas fa-user me-1"></i>{{ task.assigned_to.name }}
                                                        {% endif %}
                                                    </span>
                                                </div>
                                                <div class="mt-2">
                                                    <a href="{{ url_for('tasks.task_details', task_id=task.id) }}" class="btn btn-sm btn-outline-primary w-100">Détails</a>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                
                                <!-- Colonne "En cours" -->
                                <div class="kanban-column progress-column" data-status="en cours">
                                    <div class="kanban-title">En cours <span class="badge bg-secondary">{{ tasks_in_progress|length }}</span></div>
                                    <div class="kanban-items">
                                        {% for task in tasks_in_progress %}
                                            <div class="kanban-task" data-task-id="{{ task.id }}">
                                                <div class="task-title">{{ task.title }}</div>
                                                <div class="text-{{ task.priority }}">
                                                    <i class="fas fa-flag me-1"></i>{{ task.priority }}
                                                </div>
                                                <div class="task-info">
                                                    <span>
                                                        {% if task.estimated_time %}
                                                            <i class="fas fa-clock me-1"></i>{{ task.estimated_time }}h
                                                        {% endif %}
                                                    </span>
                                                    <span>
                                                        {% if task.user_id %}
                                                            <i class="fas fa-user me-1"></i>{{ task.assigned_to.name }}
                                                        {% endif %}
                                                    </span>
                                                </div>
                                                <div class="mt-2">
                                                    <a href="{{ url_for('tasks.task_details', task_id=task.id) }}" class="btn btn-sm btn-outline-primary w-100">Détails</a>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                
                                <!-- Colonne "Terminé" -->
                                <div class="kanban-column done-column" data-status="terminé">
                                    <div class="kanban-title">Terminé <span class="badge bg-secondary">{{ tasks_done|length }}</span></div>
                                    <div class="kanban-items">
                                        {% for task in tasks_done %}
                                            <div class="kanban-task" data-task-id="{{ task.id }}">
                                                <div class="task-title">{{ task.title }}</div>
                                                <div class="text-{{ task.priority }}">
                                                    <i class="fas fa-flag me-1"></i>{{ task.priority }}
                                                </div>
                                                <div class="task-info">
                                                    <span>
                                                        {% if task.actual_time %}
                                                            <i class="fas fa-clock me-1"></i>{{ task.actual_time }}h
                                                        {% endif %}
                                                    </span>
                                                    <span>
                                                        {% if task.completed_at %}
                                                            <i class="fas fa-calendar-check me-1"></i>{{ task.completed_at.strftime('%d/%m') }}
                                                        {% endif %}
                                                    </span>
                                                </div>
                                                <div class="mt-2">
                                                    <a href="{{ url_for('tasks.task_details', task_id=task.id) }}" class="btn btn-sm btn-outline-primary w-100">Détails</a>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <!-- Historique des crédits -->
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-history me-2"></i>Historique des crédits</h5>
                    </div>
                    <div class="card-body">
                        {% if credit_logs %}
                            <div class="list-group">
                                {% for log in credit_logs %}
                                    <div class="list-group-item">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h6 class="mb-1">
                                                {% if log.amount > 0 %}
                                                    <span class="text-success">+{{ log.amount }}h</span>
                                                {% else %}
                                                    <span class="text-danger">{{ log.amount }}h</span>
                                                {% endif %}
                                            </h6>
                                            <small class="text-muted">{{ log.created_at.strftime('%d/%m/%Y %H:%M') }}</small>
                                        </div>
                                        <p class="mb-1">{{ log.note }}</p>
                                        {% if log.task_id %}
                                            <small>
                                                <a href="{{ url_for('tasks.task_details', task_id=log.task_id) }}">
                                                    Voir la tâche
                                                </a>
                                            </small>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="text-muted">Aucun historique de crédit disponible.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modal de confirmation de suppression -->
        <div class="modal fade" id="deleteProjectModal" tabindex="-1" aria-labelledby="deleteProjectModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title" id="deleteProjectModalLabel">Confirmer la suppression</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        Êtes-vous sûr de vouloir supprimer le projet <strong>{{ project.name }}</strong> ?
                        
                        {% if project.tasks %}
                            <div class="alert alert-warning mt-3">
                                <i class="fas fa-exclamation-triangle me-2"></i>Ce projet a {{ project.tasks|length }} tâche(s) associée(s).
                                Vous devez d'abord supprimer toutes les tâches avant de pouvoir supprimer le projet.
                            </div>
                        {% else %}
                            <p class="text-danger mt-3"><i class="fas fa-exclamation-triangle me-1"></i>Cette action est irréversible.</p>
                        {% endif %}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                        {% if not project.tasks %}
                            <form action="{{ url_for('projects.delete_project', project_id=project.id) }}" method="POST">
                                <button type="submit" class="btn btn-danger">Supprimer</button>
                            </form>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endblock %}
        
        {% block scripts %}
        <script>
            // Fonctionnalités de glisser-déposer pour le Kanban
            document.addEventListener('DOMContentLoaded', function() {
                const kanbanTasks = document.querySelectorAll('.kanban-task');
                const kanbanColumns = document.querySelectorAll('.kanban-column');
                
                // Configuration du drag and drop
                kanbanTasks.forEach(task => {
                    task.setAttribute('draggable', true);
                    
                    task.addEventListener('dragstart', function(e) {
                        e.dataTransfer.setData('text/plain', task.dataset.taskId);
                        task.classList.add('dragging');
                    });
                    
                    task.addEventListener('dragend', function() {
                        task.classList.remove('dragging');
                    });
                });
                
                kanbanColumns.forEach(column => {
                    column.addEventListener('dragover', function(e) {
                        e.preventDefault();
                        column.classList.add('drag-over');
                    });
                    
                    column.addEventListener('dragleave', function() {
                        column.classList.remove('drag-over');
                    });
                    
                    column.addEventListener('drop', function(e) {
                        e.preventDefault();
                        column.classList.remove('drag-over');
                        
                        const taskId = e.dataTransfer.getData('text/plain');
                        const newStatus = column.dataset.status;
                        
                        // Appel AJAX pour mettre à jour le statut
                        fetch('/tasks/update_status', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                task_id: taskId,
                                status: newStatus
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Recharger la page pour refléter les changements
                                location.reload();
                            } else {
                                alert('Erreur lors de la mise à jour du statut: ' + data.error);
                            }
                        })
                        .catch(error => {
                            console.error('Erreur:', error);
                            alert('Une erreur est survenue lors de la mise à jour');
                        });
                    });
                });
            });
        </script>
        {% endblock %}