{% extends 'layout.html' %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/tasks.css') }}">
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // Définir le token CSRF pour les requêtes AJAX
    window.csrfToken = "{{ csrf_token() }}";
</script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="{{ url_for('static', filename='js/pages/task-comments.js') }}"></script>
<script type="module">
    import { initTasksPage } from "{{ url_for('static', filename='js/pages/tasks.js') }}";
    document.addEventListener('DOMContentLoaded', initTasksPage);
</script>
<script type="module" src="{{ url_for('static', filename='js/pages/task-checklist.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/pages/task-time.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/pages/task-status.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/pages/task-pin.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/pages/task-archive.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/pages/task-recurrence.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/pages/task-attachments.js') }}"></script>
<script src="{{ url_for('static', filename='js/pages/task-description.js') }}"></script>
{% endblock %}

{% block content %}
<div class="task-detail-layout">
<!-- Barre d'actions fixe : même retrait que les cartes -->
<div class="action-toolbar sticky-top shadow-sm py-2 bg-secondary text-white rounded">
    <div class="action-toolbar-inner d-flex align-items-center gap-3">
        <h1 class="task-page-title mb-0 me-auto"><i class="fas fa-tasks me-2" aria-hidden="true"></i>{{ task.title }}</h1>
        <div class="d-flex gap-2 flex-shrink-0">
                {% if task.project.time_tracking_enabled %}
                <span id="remaining-credit-badge" class="badge {% if task.project.remaining_credit < 120 %}bg-danger{% elif task.project.remaining_credit < 300 %}bg-warning{% else %}bg-success{% endif %} text-white d-flex align-items-center" data-bs-toggle="tooltip" title="Crédit restant du projet">
                    <i class="fas fa-clock me-1"></i>{{ task.project.remaining_credit|format_time }}
                </span>
                {% endif %}
                <a href="{{ url_for('projects.project_details', slug_or_id=task.project.slug) }}" class="btn btn-outline-light" data-bs-toggle="tooltip" title="Retour au projet">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <a href="{{ url_for('tasks.edit_task', slug_or_id=task.slug) }}" class="btn btn-outline-light" data-bs-toggle="tooltip" title="Modifier">
                    <i class="fas fa-edit"></i>
                </a>
                {% if not current_user.is_client() %}
                <form action="{{ url_for('tasks.toggle_pin_task', slug_or_id=task.slug) }}" method="POST" class="d-inline menu-pin-form">
                    {% set is_pinned = task in current_user.pinned_tasks %}
                    <button type="submit" class="btn btn-outline-light" data-bs-toggle="tooltip" title="{% if is_pinned %}Désépingler{% else %}Épingler{% endif %} la tâche">
                        <i class="fas fa-thumbtack {% if is_pinned %}text-warning{% endif %}"></i>
                    </button>
                </form>
                <button type="button" class="btn btn-outline-light" data-bs-toggle="modal" data-bs-target="#timeEntryModal" title="Enregistrer du temps">
                    <i class="fas fa-clock"></i>
                </button>
                <button type="button" class="btn btn-outline-light" data-bs-toggle="modal" data-bs-target="#cloneTaskModal" title="Cloner la tâche">
                    <i class="fas fa-copy"></i>
                </button>
                {% if task.status == 'terminé' and not task.is_archived %}
                <button type="button" class="btn btn-outline-light archive-task-btn"
                        data-task-id="{{ task.id }}"
                        data-task-title="{{ task.title }}"
                        data-task-slug="{{ task.slug }}"
                        data-bs-toggle="tooltip"
                        title="Archiver la tâche">
                    <i class="fas fa-archive"></i>
                </button>
                {% elif task.is_archived %}
                <button type="button" class="btn btn-outline-light unarchive-task-btn"
                        data-task-id="{{ task.id }}"
                        data-task-title="{{ task.title }}"
                        data-task-slug="{{ task.slug }}"
                        data-bs-toggle="tooltip"
                        title="Désarchiver la tâche">
                    <i class="fas fa-undo"></i>
                </button>
                {% endif %}
                <button type="button" class="btn btn-outline-light delete-task-btn" data-bs-target="#deleteTaskModal" data-bs-toggle="modal" title="Supprimer">
                    <i class="fas fa-trash"></i>
                </button>
                {% endif %}
        </div>
    </div>
</div>

<!-- Espace pour compenser la barre fixe -->
<div class="toolbar-spacer"></div>

<!-- Une carte = Description + Informations (même largeur que Outils) -->
<div class="card no-collapse task-detail-card task-detail-main-card mb-4">
    <div class="card-body task-detail-main-body">
        <div class="row g-3 align-items-stretch">
            <div class="col-lg-8">
                <div class="task-detail-block task-detail-desc-block h-100 d-flex flex-column min-h-0">
                    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
                        <h6 class="task-tool-title mb-0"><i class="fas fa-file-alt me-1"></i>Description</h6>
                        <div class="d-flex flex-wrap align-items-center gap-2">
                            <div class="status-toggle">
                                <div class="btn-group border border-secondary rounded" role="group" aria-label="Changer le statut">
                                    <button type="button" class="btn btn-sm {% if task.status == 'à faire' %}btn-info{% else %}btn-outline-info{% endif %} status-btn"
                                            data-status="à faire" data-task-id="{{ task.id }}">
                                        <i class="fas fa-list me-1"></i>À faire
                                    </button>
                                    <button type="button" class="btn btn-sm {% if task.status == 'en cours' %}btn-warning{% else %}btn-outline-warning{% endif %} status-btn"
                                            data-status="en cours" data-task-id="{{ task.id }}">
                                        <i class="fas fa-spinner me-1"></i>En cours
                                    </button>
                                    <button type="button" class="btn btn-sm {% if task.status == 'terminé' %}btn-success{% else %}btn-outline-success{% endif %} status-btn"
                                            data-status="terminé" data-task-id="{{ task.id }}">
                                        <i class="fas fa-check me-1"></i>Terminé
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="task-detail-desc-content flex-grow-1 min-h-0 overflow-auto">
                        {% if task.description %}
                        <div class="task-info-description mb-3">
                            <p class="mb-0 task-info-description-text">{{ task.description }}</p>
                            {% if task.description|length > 250 %}
                            <a href="#"
                               class="task-info-description-more text-primary text-decoration-none mt-1 d-inline-block"
                               data-full-description="{{ task.description|e }}"
                               data-bs-toggle="modal"
                               data-bs-target="#taskDescriptionModal">
                                Voir la description complète
                            </a>
                            {% endif %}
                        </div>
                        {% else %}
                        <p class="text-muted small mb-0">Aucune description.</p>
                        {% endif %}
                        <hr class="my-3">
                        <div class="task-contexte small">
                            <strong class="d-block mb-2 text-muted">Contexte</strong>
                            <ul class="list-unstyled mb-0">
                                <li class="mb-1">
                                    <i class="fas fa-project-diagram me-2 text-muted"></i>
                                    <span class="text-muted">Projet :</span>
                                    <a href="{{ url_for('projects.project_details', slug_or_id=task.project.slug) }}" class="text-decoration-none project-name">{{ task.project.name }}</a>
                                </li>
                                <li class="mb-1">
                                    <i class="fas fa-building me-2 text-muted"></i>
                                    <span class="text-muted">Client :</span>
                                    <a href="{{ url_for('clients.client_details', slug_or_id=task.project.client.slug) }}" class="text-decoration-none">{{ task.project.client.name }}</a>
                                </li>
                                <li>
                                    <i class="fas fa-user me-2 text-muted"></i>
                                    <span class="text-muted">Assigné à :</span> {{ task.assigned_to.name if task.user_id else 'Non assigné' }}
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="task-detail-block task-detail-info-block h-100">
                    <h6 class="task-tool-title mb-2"><i class="fas fa-info-circle me-1"></i>Informations</h6>
                    <div class="task-info-compact">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-flag me-2 text-muted"></i>
                            <span class="badge bg-{{ task.priority|priority_color }}">{{ task.priority }}</span>
                        </div>
                        <div class="small text-muted mb-1">Créée le {{ task.created_at.strftime('%d/%m/%Y') }}</div>
                        {% if task.completed_at %}
                        <div class="small text-muted mb-1">Terminée le {{ task.completed_at.strftime('%d/%m/%Y') }}</div>
                        {% endif %}
                        <div class="small text-muted mb-2">Dernière activité : {% if comments %}{{ comments[0].created_at.strftime('%d/%m %H:%M') }}{% else %}{{ task.updated_at.strftime('%d/%m %H:%M') }}{% endif %}</div>
                        <div class="d-flex align-items-start gap-2 mb-2">
                            <div class="small flex-grow-1">
                                <span id="recurrence-summary-text">{{ recurrence_info.summary }}</span>
                                <span id="recurrence-next-text" class="text-muted">{% if recurrence_info.next_date %}({{ recurrence_info.next_date }}){% endif %}</span>
                            </div>
                            <div class="btn-group btn-group-sm flex-shrink-0" role="group" aria-label="Récurrence">
                                <button type="button" class="btn btn-outline-secondary py-0 px-1" id="recurrence-edit-btn" data-task-slug="{{ task.slug }}" data-bs-toggle="tooltip" title="{% if task.recurrence_series %}Modifier{% else %}Ajouter{% endif %}"><i class="fas fa-edit"></i></button>
                                <button type="button" class="btn btn-outline-danger py-0 px-1" id="recurrence-delete-btn" data-task-slug="{{ task.slug }}" {% if not task.recurrence_series %}disabled{% endif %} data-bs-toggle="tooltip" title="Supprimer"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        <div class="pt-2 border-top d-flex flex-wrap align-items-center gap-3">
                            <button type="button" class="time-total-trigger" data-bs-toggle="modal" data-bs-target="#timeHistoryModal" title="Voir l'historique du temps">
                                <span class="small text-muted">Temps total :</span>
                                <span id="total-time-badge" class="time-total-badge">{{ task.actual_time|format_time if task.actual_time else '0 min' }}</span>
                            </button>
                            <button type="button" class="comments-count-trigger time-total-trigger" data-bs-toggle="modal" data-bs-target="#commentsModal" title="Voir les commentaires">
                                <span class="small text-muted">Commentaires :</span>
                                <span id="comments-count-badge" class="time-total-badge">{{ comments|length }}</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Outils : une carte, même largeur que la carte au-dessus -->
<div class="card no-collapse task-detail-card task-tools-card mb-3">
            <div class="card-header task-detail-card-header py-2">
                <h5 class="mb-0 small"><i class="fas fa-wrench me-2"></i>Outils</h5>
            </div>
            <div class="card-body task-tools-body">
                <div class="row g-3">
                    <!-- Pièces jointes -->
                    <div class="col-md-5 col-lg-4">
                        <div class="task-tool-block h-100">
                            <h6 class="task-tool-title">
                                <i class="fas fa-paperclip me-1"></i>Pièces jointes
                                <span class="badge bg-secondary ms-1" id="attachments-count">{{ task_attachments|length }}</span>
                            </h6>
                            <div id="task-attachments-container" data-task-slug="{{ task.slug }}">
                                <form id="task-attachments-upload-form" class="mb-2" method="POST" action="{{ url_for('tasks.upload_task_attachments', slug_or_id=task.slug) }}" enctype="multipart/form-data">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <input type="file" name="files" id="task-attachments-input" class="d-none" multiple accept=".csv,.pdf,.zip,.doc,.docx,.xls,.xlsx,.7z,.tar,.gz" aria-label="Fichiers">
                                    <div id="pj-upload-zone" class="pj-upload-zone" role="button" tabindex="0" aria-label="Ajouter des pièces jointes">
                                        <i class="fas fa-cloud-upload-alt pj-upload-zone-icon"></i>
                                        <span class="pj-upload-zone-text">Glissez des fichiers ici ou <strong>cliquez</strong></span>
                                        <span class="pj-upload-zone-hint small text-muted">csv, pdf, zip, doc, xls…</span>
                                    </div>
                                    <button type="submit" class="d-none" id="task-attachments-submit">Envoyer</button>
                                </form>
                                <ul id="task-attachments-list" class="list-group list-group-flush list-group-sm task-tool-list mb-0">
                                    {% for att in task_attachments %}
                                    <li class="list-group-item d-flex align-items-center py-1 px-2 task-attachment-item" data-attachment-id="{{ att.id }}">
                                        <a href="{{ url_for('tasks.download_task_attachment', slug_or_id=task.slug, file_id=att.id) }}" class="text-decoration-none flex-grow-1 text-truncate me-2 small" title="Télécharger {{ att.name }}">
                                            <i class="fas fa-file-alt me-1 text-muted"></i><span class="task-attachment-name">{{ att.name }}</span> <small class="text-muted">({{ (att.size / 1024)|round(1) }} Ko)</small>
                                        </a>
                                        <button type="button" class="btn btn-sm btn-link text-danger py-0 px-1 delete-attachment-btn" title="Supprimer" data-attachment-id="{{ att.id }}"><i class="fas fa-times"></i></button>
                                    </li>
                                    {% else %}
                                    <li id="task-attachments-empty" class="list-group-item text-muted small py-1 px-2">Aucune pièce jointe</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                    <!-- Checklist -->
                    <div class="col-md-7 col-lg-8">
                        <div class="task-tool-block task-tool-checklist task-tool-checklist-wide h-100">
                            <div class="checklist-header-strip">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <h6 class="task-tool-title mb-0"><i class="fas fa-tasks me-1"></i>Checklist</h6>
                                    <div class="checklist-actions">
                                    <button type="button" class="btn btn-sm btn-outline-primary py-0 px-1 me-1 toggle-checklist-size" title="Agrandir/Réduire"><i class="fas fa-expand-alt"></i></button>
                                    {% if task.recurrence_series %}
                                    <button type="button" class="btn btn-sm btn-outline-primary py-0 px-1 me-1" id="sync-checklist-future-button" data-bs-toggle="tooltip" title="Appliquer aux occurrences futures"><i class="fas fa-repeat"></i></button>
                                    {% endif %}
                                    <button type="button" class="btn btn-sm btn-outline-primary py-0 px-1" id="add-checklist-shortcode-button" title="Shortcode"><i class="fas fa-code"></i></button>
                                    </div>
                                </div>
                                <div id="checklist-progress-wrap" class="checklist-progress-wrap" aria-hidden="true">
                                    {% set cl_total = task.checklist_items|length %}
                                    {% set cl_done = task.checklist_items|selectattr('is_checked')|list|length %}
                                    <div class="checklist-progress-bar" role="progressbar" aria-valuenow="{{ cl_done }}" aria-valuemin="0" aria-valuemax="{{ cl_total or 1 }}" title="{{ cl_done }} / {{ cl_total }} terminés">
                                        <span class="checklist-progress-fill" style="width: {{ (100 * cl_done / (cl_total or 1))|int }}%;"></span>
                                    </div>
                                    <span class="checklist-progress-text small text-muted">{{ cl_done }} / {{ cl_total }}</span>
                                </div>
                            </div>
                            <div id="checklist-container" class="checklist-container" data-task-id="{{ task.id }}">
                                <div id="checklist-items" class="checklist-items">
                                    {% for item in task.checklist_items|sort(attribute='position') %}
                                    <div class="checklist-item {% if item.is_checked %}is-checked{% endif %}" data-id="{{ item.id }}">
                                        <div class="form-check d-flex align-items-center justify-content-between">
                                            <div class="d-flex align-items-center flex-grow-1">
                                                <input class="form-check-input checklist-checkbox me-2" type="checkbox" id="checklist-item-{{ item.id }}" {% if item.is_checked %}checked{% endif %}>
                                                <div class="checklist-drag-handle me-2" title="Déplacer"><i class="fas fa-grip-vertical text-muted"></i></div>
                                                <label class="form-check-label mb-0 small" for="checklist-item-{{ item.id }}"><span class="checklist-content">{{ item.content }}</span></label>
                                            </div>
                                            <div class="btn-group btn-group-sm ms-2">
                                                <button type="button" class="btn btn-outline-primary btn-sm py-0 px-1 copy-to-time-btn {% if not item.is_checked %}disabled{% endif %}" title="Copier dans le temps" {% if not item.is_checked %}disabled{% endif %}><i class="fas fa-clock"></i></button>
                                                <button type="button" class="btn btn-outline-danger btn-sm py-0 px-1 delete-checklist-item" title="Supprimer"><i class="fas fa-times"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                <form id="add-checklist-item-form" class="checklist-add-form mt-1">
                                    <input type="text" id="add-checklist-item-input" class="form-control form-control-sm" placeholder="Ajouter un élément...">
                                    <span class="checklist-add-form-hint text-muted small"><i class="fas fa-keyboard"></i> Entrée</span>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
</div>

</div><!-- /.task-detail-layout -->

<!-- Conteneur de toasts -->
<div id="toast-container" class="toast-container position-fixed bottom-0 end-0 p-3"></div>

<!-- Modal Historique du temps (ouverte au clic sur "Temps total" dans Informations) -->
<div class="modal fade" id="timeHistoryModal" tabindex="-1" aria-labelledby="timeHistoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-secondary text-white">
                <h5 class="modal-title" id="timeHistoryModalLabel">
                    <i class="fas fa-history me-2"></i>Historique du temps
                    <span id="total-time-badge-modal" class="badge bg-light text-dark ms-2">{{ task.actual_time|format_time if task.actual_time else '0 min' }}</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
                <div class="time-history">
                    {% if time_entries %}
                    <div class="list-group list-group-flush">
                        {% for entry in time_entries %}
                        <div class="list-group-item py-2 px-0 time-entry-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-primary fw-medium">{{ entry.hours|format_time }}</span>
                                <small class="text-muted">{{ entry.created_at.strftime('%d/%m %H:%M') }}</small>
                            </div>
                            <small class="text-muted d-block">{{ entry.user.name }}</small>
                            {% if entry.description %}<small class="text-muted d-block mt-1">{{ entry.description }}</small>{% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted small mb-0">Aucun temps enregistré</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Commentaires (ouverte au clic sur "Commentaires" dans Informations) -->
<div class="modal fade" id="commentsModal" tabindex="-1" aria-labelledby="commentsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-secondary text-white">
                <h5 class="modal-title" id="commentsModalLabel">
                    <i class="fas fa-comments me-2"></i>Commentaires
                    <span class="badge bg-light text-dark ms-2" id="comments-modal-badge">{{ comments|length }}</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
                {% if comments %}
                <div class="comment-list comments-modal-list">
                    {% for comment in comments %}
                    <div class="comment-item {% if comment.user_id == current_user.id %}own-comment{% endif %}">
                        <div class="comment-header">
                            <span class="comment-author">{{ comment.user.name }}</span>
                            <span class="comment-time">{{ comment.created_at.strftime('%d/%m/%Y %H:%M') }}</span>
                        </div>
                        <div class="comment-content">{{ comment.content }}</div>
                        {% if comment.replies %}
                        <div class="comment-replies">
                            {% for reply in comment.replies %}
                            <div class="comment-reply {% if reply.user_id == current_user.id %}own-comment{% endif %}">
                                <div class="comment-header">
                                    <span class="comment-author">{{ reply.user.name }}</span>
                                    <span class="comment-time">{{ reply.created_at.strftime('%d/%m/%Y %H:%M') }}</span>
                                </div>
                                <div class="comment-content">{{ reply.content }}</div>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted mb-0">Aucun commentaire.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal récurrence -->
<div class="modal fade" id="recurrenceModal" tabindex="-1" aria-labelledby="recurrenceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-secondary text-white">
                <h5 class="modal-title" id="recurrenceModalLabel">
                    <i class="fas fa-repeat me-2"></i>Récurrence
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
                <form id="recurrence-form">
                    <input type="hidden" id="recurrence-task-slug" value="{{ task.slug }}">

                    <div class="mb-3">
                        <label for="recurrence-frequency" class="form-label">Fréquence</label>
                        <select id="recurrence-frequency" class="form-select">
                            <option value="daily">Quotidienne</option>
                            <option value="weekly">Hebdomadaire</option>
                            <option value="monthly">Mensuelle</option>
                        </select>
                    </div>

                    <div class="row">
                        <div class="col-6">
                            <div class="mb-3">
                                <label for="recurrence-interval" class="form-label">Intervalle</label>
                                <input type="number" min="1" max="365" step="1" id="recurrence-interval" class="form-control" value="1">
                                <div class="form-text">Ex: 2 = toutes les 2 semaines</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="mb-3">
                                <label for="recurrence-start-date" class="form-label">Début</label>
                                <input type="date" id="recurrence-start-date" class="form-control">
                            </div>
                        </div>
                    </div>

                    <div id="recurrence-weekdays-section" class="mb-3 d-none">
                        <label class="form-label">Jours</label>
                        <div class="d-flex flex-wrap gap-2">
                            <div class="form-check">
                                <input class="form-check-input recurrence-weekday" type="checkbox" value="0" id="recur-wd-0">
                                <label class="form-check-label" for="recur-wd-0">Lun</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input recurrence-weekday" type="checkbox" value="1" id="recur-wd-1">
                                <label class="form-check-label" for="recur-wd-1">Mar</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input recurrence-weekday" type="checkbox" value="2" id="recur-wd-2">
                                <label class="form-check-label" for="recur-wd-2">Mer</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input recurrence-weekday" type="checkbox" value="3" id="recur-wd-3">
                                <label class="form-check-label" for="recur-wd-3">Jeu</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input recurrence-weekday" type="checkbox" value="4" id="recur-wd-4">
                                <label class="form-check-label" for="recur-wd-4">Ven</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input recurrence-weekday" type="checkbox" value="5" id="recur-wd-5">
                                <label class="form-check-label" for="recur-wd-5">Sam</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input recurrence-weekday" type="checkbox" value="6" id="recur-wd-6">
                                <label class="form-check-label" for="recur-wd-6">Dim</label>
                            </div>
                        </div>
                    </div>

                    <div id="recurrence-business-days-section" class="mb-3 d-none">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="1" id="recurrence-business-days-only">
                            <label class="form-check-label" for="recurrence-business-days-only">
                                Jours ouvrés uniquement (Lun–Ven)
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Fin</label>
                        <select id="recurrence-end-type" class="form-select">
                            <option value="never">Sans fin</option>
                            <option value="until">Jusqu'au</option>
                            <option value="count">Nombre d'occurrences</option>
                        </select>
                    </div>

                    <div class="row">
                        <div class="col-6">
                            <div class="mb-3 d-none" id="recurrence-end-date-wrapper">
                                <label for="recurrence-end-date" class="form-label">Date de fin</label>
                                <input type="date" id="recurrence-end-date" class="form-control">
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="mb-3 d-none" id="recurrence-count-wrapper">
                                <label for="recurrence-count" class="form-label">Occurrences</label>
                                <input type="number" min="1" max="1000" step="1" id="recurrence-count" class="form-control">
                            </div>
                        </div>
                    </div>
                </form>
                <div class="form-text">
                    Les occurrences futures sont créées automatiquement et n’apparaissent qu’à leur date.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="recurrence-save-btn">
                    <i class="fas fa-save me-1"></i>Enregistrer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour l'enregistrement du temps -->
{% if not current_user.is_client() %}
<div class="modal fade" id="timeEntryModal" tabindex="-1" aria-labelledby="timeEntryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-secondary text-white">
                <h5 class="modal-title" id="timeEntryModalLabel">
                    <i class="fas fa-clock me-2"></i>Enregistrer du temps
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
                {% if task.project.time_tracking_enabled %}
                <div class="alert {% if task.project.remaining_credit < 120 %}alert-danger{% elif task.project.remaining_credit < 300 %}alert-warning{% else %}alert-success{% endif %} mb-4 no-auto-close">
                    <div class="d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-info-circle me-2"></i>Crédit du projet:</span>
                        <strong class="{% if task.project.remaining_credit < 120 %}text-danger{% elif task.project.remaining_credit < 300 %}text-warning{% else %}text-success{% endif %} ms-2">
                            {{ task.project.remaining_credit|format_time }}
                        </strong>
                    </div>
                </div>
                {% endif %}

                <form method="POST" action="{{ url_for('tasks.log_time', slug_or_id=task.slug) }}">
                    {{ time_form.hidden_tag() }}
                    <div class="mb-3">
                        {{ time_form.hours.label(class="form-label") }}
                        {% if time_form.hours.errors %}
                            {{ time_form.hours(class="form-select is-invalid") }}
                            <div class="invalid-feedback">
                                {% for error in time_form.hours.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% else %}
                            {{ time_form.hours(class="form-select") }}
                        {% endif %}
                        <div class="form-text">Temps par tranches de 15 minutes</div>
                    </div>
                    <div class="mb-3">
                        {{ time_form.description.label(class="form-label") }}
                        {% if time_form.description.errors %}
                            {{ time_form.description(class="form-control is-invalid", rows=3) }}
                            <div class="invalid-feedback">
                                {% for error in time_form.description.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% else %}
                            {{ time_form.description(class="form-control", rows=3) }}
                        {% endif %}
                    </div>
                    <div class="text-end">
                        {{ time_form.submit(class="btn btn-primary") }}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Modal de confirmation suppression d'un élément de checklist -->
<div class="modal fade" id="deleteChecklistItemModal" tabindex="-1" aria-labelledby="deleteChecklistItemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteChecklistItemModalLabel">
                    <i class="fas fa-trash-alt me-2 text-danger"></i>Supprimer l'élément
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
                <p class="mb-0">Supprimer cet élément de la checklist ? Cette action est irréversible.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-danger" id="deleteChecklistItemConfirmBtn">
                    <i class="fas fa-trash-alt me-1"></i>Supprimer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Commentaires : même largeur que le contenu au-dessus -->
<div class="task-detail-layout">
<div class="card mb-4 no-collapse task-detail-card">
    <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-comments me-2"></i>Commentaires</h5>
        <span class="badge bg-light text-secondary">{{ comments|length }}</span>
    </div>
    <div class="card-body">
        <!-- Formulaire pour ajouter un commentaire -->
        <form method="POST" action="{{ url_for('tasks.add_comment', slug_or_id=task.slug) }}" class="mb-4">
            {{ comment_form.hidden_tag() }}
            <input type="hidden" name="mentions" value="[]">
            <div class="mb-3 position-relative">
                {{ comment_form.content.label(class="form-label") }}
                {% if comment_form.content.errors %}
                    {{ comment_form.content(class="form-control is-invalid comment-input", rows=4, **{'data-project-id': task.project.slug}) }}
                    <div class="invalid-feedback">
                        {% for error in comment_form.content.errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                {% else %}
                    {{ comment_form.content(class="form-control comment-input", rows=4, **{'data-project-id': task.project.slug}) }}
                {% endif %}
                <div class="comment-submit-container d-flex align-items-center gap-3">
                    <div class="form-check">
                        {{ comment_form.notify_all(class="form-check-input") }}
                        {{ comment_form.notify_all.label(class="form-check-label") }}
                    </div>
                    {{ comment_form.submit(class="btn btn-primary") }}
                </div>
            </div>
        </form>

        <hr>
        <!-- Liste des commentaires existants -->
        {% if comments %}
        <div class="comment-list">
            {% for comment in comments %}
            <div class="comment-item {% if comment.user_id == current_user.id %}own-comment{% endif %}" id="comment-{{ comment.id }}">
                <div class="comment-header">
                    <span class="comment-author">{{ comment.user.name }}</span>
                    <div class="d-flex align-items-center">
                        <span class="comment-time">{{ comment.created_at.strftime('%d/%m/%Y %H:%M') }}</span>
                        {% set minutes_elapsed = ((now.replace(tzinfo=None) - comment.created_at).total_seconds() / 60)|int %}
                        {% set can_edit = minutes_elapsed < 10 and (comment.user_id == current_user.id or current_user.is_admin()) %}
                        <div class="d-inline-block ms-2">
                            {% if can_edit %}
                                <span class="edit-timer" title="Temps restant pour éditer">
                                    {{ 10 - minutes_elapsed }} min
                                </span>
                                <button type="button" class="btn btn-sm btn-outline-secondary edit-comment-btn"
                                        data-comment-id="{{ comment.id }}" title="Modifier">
                                    <i class="fas fa-edit"></i>
                                </button>
                            {% endif %}
                            {% if comment.user_id == current_user.id or current_user.is_admin() %}
                                <form action="{{ url_for('tasks.delete_comment', comment_id=comment.id) }}" method="POST" class="d-inline delete-comment-form">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn-sm btn-outline-secondary" title="Supprimer">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="comment-content">
                    {{ comment.content }}
                </div>
                <button type="button" class="reply-button" data-comment-id="{{ comment.id }}">
                    <i class="fas fa-reply me-1"></i>Répondre
                </button>
                <div class="comment-reply-form" id="reply-form-{{ comment.id }}" style="display: none;">
                    <form method="POST" action="{{ url_for('tasks.add_reply', comment_id=comment.id) }}" class="reply-form">
                        {{ comment_form.hidden_tag() }}
                        <div class="mb-2">
                            {{ comment_form.content(class="form-control", rows=2, placeholder="Écrivez votre réponse...") }}
                        </div>
                        <div class="d-flex justify-content-end gap-2">
                            <button type="button" class="btn btn-sm btn-outline-light cancel-reply-btn" data-comment-id="{{ comment.id }}">Annuler</button>
                            {{ comment_form.submit(class="btn btn-sm btn-light") }}
                        </div>
                    </form>
                </div>
                {% if comment.replies %}
                <div class="comment-replies">
                    {% for reply in comment.replies %}
                    <div class="comment-reply {% if reply.user_id == current_user.id %}own-comment{% endif %}" id="reply-{{ reply.id }}">
                        <div class="comment-header">
                            <span class="comment-author">{{ reply.user.name }}</span>
                            <div class="d-flex align-items-center">
                                <span class="comment-time">{{ reply.created_at.strftime('%d/%m/%Y %H:%M') }}</span>
                                {% if reply.user_id == current_user.id or current_user.is_admin() %}
                                    <div class="d-inline-block ms-2">
                                        {% set reply_minutes_elapsed = ((now.replace(tzinfo=None) - reply.created_at).total_seconds() / 60)|int %}
                                        {% if reply_minutes_elapsed < 10 %}
                                            <span class="edit-timer" title="Temps restant pour éditer">
                                                {{ 10 - reply_minutes_elapsed }} min
                                            </span>
                                            <button type="button" class="btn btn-sm btn-outline-secondary edit-comment-btn"
                                                    data-comment-id="{{ reply.id }}" title="Modifier">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        {% endif %}
                                        <form action="{{ url_for('tasks.delete_comment', comment_id=reply.id) }}" method="POST" class="d-inline delete-comment-form">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <button type="submit" class="btn btn-sm btn-outline-secondary" title="Supprimer">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="comment-content">
                            {{ reply.content }}
                        </div>
                        {% if reply.user_id == current_user.id or current_user.is_admin() %}
                            {% set reply_minutes_elapsed = ((now.replace(tzinfo=None) - reply.created_at).total_seconds() / 60)|int %}
                            {% if reply_minutes_elapsed < 10 %}
                                <form id="edit-form-{{ reply.id }}" method="POST" action="{{ url_for('tasks.edit_comment', comment_id=reply.id) }}" class="edit-comment-form" style="display: none;">
                                    {{ edit_comment_form.hidden_tag() }}
                                    <div class="mb-2">
                                        {{ edit_comment_form.content(class="form-control", rows=2) }}
                                    </div>
                                    <div class="d-flex justify-content-end gap-2">
                                        <button type="button" class="btn btn-sm btn-outline-light cancel-edit-btn" data-comment-id="{{ reply.id }}">Annuler</button>
                                        {{ edit_comment_form.submit(class="btn btn-sm btn-light") }}
                                    </div>
                                </form>
                            {% endif %}
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                {% if can_edit %}
                <form id="edit-form-{{ comment.id }}" method="POST" action="{{ url_for('tasks.edit_comment', comment_id=comment.id) }}" class="edit-comment-form" style="display: none;">
                    {{ edit_comment_form.hidden_tag() }}
                    <div class="mb-2">
                        {{ edit_comment_form.content(class="form-control", rows=2) }}
                    </div>
                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-sm btn-outline-light cancel-edit-btn" data-comment-id="{{ comment.id }}">Annuler</button>
                        {{ edit_comment_form.submit(class="btn btn-sm btn-light") }}
                    </div>
                </form>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-muted">Aucun commentaire pour le moment.</p>
        {% endif %}
    </div>
</div>
</div><!-- /.task-detail-layout (commentaires) -->

<!-- Modal de suppression -->
<div class="modal fade" id="deleteTaskModal" tabindex="-1" aria-labelledby="deleteTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteTaskModalLabel">Confirmer la suppression</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
                Êtes-vous sûr de vouloir supprimer la tâche "{{ task.title }}" ? Cette action est irréversible.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <form action="{{ url_for('tasks.delete_task', slug_or_id=task.slug) }}" method="POST">
                    {{ form.hidden_tag() }}
                    {{ form.submit(class="btn btn-danger") }}
                </form>
            </div>
        </div>
    </div>
</div>

{% if not current_user.is_client() %}
    <!-- Modal de clonage -->
    <div class="modal fade" id="cloneTaskModal" tabindex="-1" aria-labelledby="cloneTaskModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cloneTaskModalLabel">Cloner la tâche</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-2">Voulez-vous cloner la tâche <strong>"{{ task.title }}"</strong> ?</p>
                    <div id="cloneChecklistWrapper" class="{% if task.checklist_items|length == 0 %}d-none{% endif %}">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="1" id="cloneChecklist" checked>
                            <label class="form-check-label" for="cloneChecklist">
                                Cloner les sous-tâches (checklist)
                            </label>
                            <div class="form-text">
                                Le temps consommé / l’historique reste indépendant et n’est pas cloné.
                            </div>
                        </div>
                    </div>
                    <div id="cloneChecklistEmptyNote" class="text-muted small {% if task.checklist_items|length > 0 %}d-none{% endif %}">
                        Aucune sous-tâche à cloner (checklist vide).
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <form action="{{ url_for('tasks.clone_task', slug_or_id=task.slug) }}" method="POST">
                        <input type="hidden" name="clone_checklist" id="cloneChecklistHidden" value="{% if task.checklist_items|length > 0 %}1{% else %}0{% endif %}">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-copy me-1"></i>Cloner
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const modalEl = document.getElementById('cloneTaskModal');
            const wrapper = document.getElementById('cloneChecklistWrapper');
            const emptyNote = document.getElementById('cloneChecklistEmptyNote');
            const checkbox = document.getElementById('cloneChecklist');
            const hidden = document.getElementById('cloneChecklistHidden');
            if (!modalEl || !wrapper || !emptyNote || !checkbox || !hidden) return;

            const syncHiddenWithCheckbox = () => { hidden.value = checkbox.checked ? '1' : '0'; };

            // Mettre à jour l'UI au moment d'ouvrir le modal (checklist peut évoluer en AJAX).
            modalEl.addEventListener('show.bs.modal', function() {
                const hasChecklistItems = document.querySelectorAll('#checklist-items .checklist-item').length > 0;

                if (hasChecklistItems) {
                    wrapper.classList.remove('d-none');
                    emptyNote.classList.add('d-none');
                    // Valeur par défaut: on clone la checklist si elle existe
                    checkbox.checked = true;
                    syncHiddenWithCheckbox();
                } else {
                    wrapper.classList.add('d-none');
                    emptyNote.classList.remove('d-none');
                    hidden.value = '0';
                }
            });

            // Synchroniser l'état de la checkbox avec le champ envoyé au serveur.
            checkbox.addEventListener('change', syncHiddenWithCheckbox);
            syncHiddenWithCheckbox();
        });
    </script>
{% endif %}

<!-- Modal d'archivage -->
<div class="modal fade" id="archiveTaskModal" tabindex="-1" aria-labelledby="archiveTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="archiveTaskModalLabel">Confirmer l'archivage</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
                <p>Êtes-vous sûr de vouloir archiver la tâche <strong id="archiveTaskTitle"></strong> ?</p>
                <p class="text-muted mb-0">La tâche sera déplacée vers les archives et n'apparaîtra plus dans le kanban.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-warning" id="confirmArchiveBtn">
                    <i class="fas fa-archive me-1"></i>Archiver
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de désarchivage -->
<div class="modal fade" id="unarchiveTaskModal" tabindex="-1" aria-labelledby="unarchiveTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="unarchiveTaskModalLabel">Confirmer le désarchivage</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
                <p>Êtes-vous sûr de vouloir désarchiver la tâche <strong id="unarchiveTaskTitle"></strong> ?</p>
                <p class="text-muted mb-0">La tâche réapparaîtra dans le kanban du projet.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-success" id="confirmUnarchiveBtn">
                    <i class="fas fa-undo me-1"></i>Désarchiver
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour le shortcode -->
<div class="modal fade" id="shortcode-modal" tabindex="-1" aria-labelledby="shortcodeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-secondary text-white">
                <h5 class="modal-title" id="shortcodeModalLabel">
                    <i class="fas fa-code me-2"></i>Ajouter un shortcode
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="shortcode-input" class="form-label">Code à ajouter</label>
                    <input type="text" class="form-control" id="shortcode-input" placeholder="Entrez le code...">
                    <div class="form-text">
                        <p class="mb-2 text-secondary">Format du shortcode :</p>
                        <code class="d-block bg-light text-dark p-2 rounded">tasks["tâche 1", "tâche 2", "tâche 3"]</code>
                        <p class="mt-2 mb-0 text-secondary">Exemple :</p>
                        <code class="d-block bg-light text-dark p-2 rounded">tasks["Développer la page d'accueil", "Ajouter le formulaire de contact", "Mettre en place l'authentification"]</code>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="shortcode-submit">Ajouter</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal description complète de la tâche -->
<div class="modal fade" id="taskDescriptionModal" tabindex="-1" aria-labelledby="taskDescriptionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskDescriptionModalLabel">
                    <i class="fas fa-align-left me-2"></i>Description de la tâche
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
                <div class="task-info-description-content">
                    <p id="taskFullDescriptionText" class="mb-0"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
